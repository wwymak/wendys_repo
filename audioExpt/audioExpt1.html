<!DOCTYPE html>
<html>
	<head>
		<script src="../js/jquery-1.10.2.min.js" type="text/javascript"></script>
		<!--<script src="../js/three.js" type="text/javascript"></script>-->
		<style>
			body{
				margin: 0;
				overflow: hidden;
				/*background-color: #ffffff;*/
			}
		</style>
	</head>
	<body>
		<canvas id="canvas"></canvas>
		<button id="playBtn">Play</button>
		<script type="text/javascript">
		//Chris_Zabriskie_Cylinder_One.mp3 from http://freemusicarchive.org

		var contextClass = (window.AudioContext ||
		    window.webkitAudioContext ||
		    window.mozAudioContext ||
		    window.oAudioContext ||
		    window.msAudioContext);
		if (contextClass) {
		    // Web Audio API is available.
		    var context = new contextClass();
		}
		else {
		// Web Audio API is not available. Ask the user to use a supported browser.
			alert("web audio api not available. Please use a modern browser !");

		}

		var sound, source;
        var canvas = document.getElementById('canvas');
		var ctx = canvas.getContext('2d');

		setupAudioNode();
		loadSound('Chris_Zabriskie_Cylinder_One.mp3');

		function loadSound(url){
			var request = new XMLHttpRequest();
				// var url = 'Chris_Zabriskie_Cylinder_One.mp3';
			request.open('GET', url, true);
			request.responseType = 'arraybuffer';

			// Decode asynchronously
			request.onload = function() {
			    context.decodeAudioData(request.response, function(theBuffer) {
			    sound = theBuffer;
			    $("#playBtn").on("click", function(){play(sound)});
			  }, onError);
			}
			request.send();
		}

		function setupAudioNode(){
			source = context.createBufferSource();
			source.connect(context.destination);

			javascriptNode = context.createScriptProcessor(2048,1,1);
			javascriptNode.connect(context.destination);

			analyser = context.createAnalyser();
			analyser.fftsize = 1024;
			analyser.smoothingTimeConstant = 0.3;

			source.connect(analyser);
			analyser.connect(javascriptNode);
		}

		function play(buffer){
			source.buffer= buffer;
			source.start(0);

		}

		function onError(e) {
		  console.log('Error', e);
		}



		// var javascriptNode = context.createScriptProcessor(2048,1,1);
		javascriptNode.onaudioprocess = function(){
			var array = new Unit8Array(analyser.frequencyBinCount);

			var gradient=ctx.createLinearGradient(0,0,170,0);
			gradient.addColorStop(0,"black");
			gradient.addColorStop(0.5,"red");
			ctx.fillStyle = gradient;

		}






		</script>
	</body>
</html>